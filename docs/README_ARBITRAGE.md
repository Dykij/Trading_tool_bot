# Продвинутый анализ арбитражных возможностей на DMarket

Этот документ описывает использование улучшенной системы для анализа арбитражных возможностей на площадке DMarket. Система включает в себя:

- Анализ ликвидности предметов на основе истории продаж
- Прогнозирование цен с использованием машинного обучения
- Оценку рисков и общую оценку привлекательности возможностей
- Асинхронную параллельную обработку для быстрого анализа

## Предварительные требования

1. Python 3.8 или выше
2. Установленные зависимости из `requirements.txt`
3. API ключи DMarket (должны быть указаны в файле `.env`)

```
DMARKET_API_KEY=ваш_ключ_api
DMARKET_API_SECRET=ваш_секрет_api
```

## Запуск анализа

### Базовый запуск

```bash
python src/arbitrage/advanced_arbitrage_test.py
```

### Параметры анализа

Вы можете изменить параметры анализа, отредактировав функцию `main()` в файле `src/arbitrage/advanced_arbitrage_test.py`:

```python
# Параметры анализа
price_from = 1.0  # Минимальная цена предметов для анализа
price_to = 100.0  # Максимальная цена предметов для анализа
min_profit_percent = 5.0  # Минимальный процент прибыли
max_items_per_game = 50  # Количество предметов для анализа в каждой игре
min_opportunity_score = 0.3  # Минимальная оценка возможности (от 0 до 1)
use_ml = True  # Использовать машинное обучение для прогнозирования цен
```

## Результаты анализа

Результаты анализа сохраняются в директории `results/` в формате JSON. В консоль выводится сводка с топ-5 наиболее перспективными предметами для каждой игры.

### Оценка возможностей

Каждая арбитражная возможность оценивается по нескольким параметрам:

- **Чистая прибыль** - ожидаемая прибыль с учетом комиссий
- **Процент прибыли** - прибыль в процентах от цены покупки
- **Оценка ликвидности** - насколько быстро можно продать предмет
- **Оценка риска** - риск неполучения ожидаемой прибыли
- **Общая оценка возможности** - композитная оценка привлекательности с учетом прибыли и рисков

## Компоненты системы

### Модуль анализа ликвидности

Файл `src/arbitrage/liquidity_analyzer.py` содержит:
- Класс `LiquidityAnalyzer` для оценки ликвидности предметов
- Метод `calculate_realistic_profit` для расчета реалистичной прибыли

### Модуль машинного обучения

Файл `src/ml/ml_predictor.py` содержит:
- Класс `MLPredictor` для прогнозирования цен на предметы
- Модель машинного обучения для анализа трендов цен

### Улучшенный API-клиент

В файле `src/api/api_wrapper.py` добавлена:
- Метод `get_item_history_safe` с улучшенной обработкой ошибок
- Поддержка повторных попыток и альтернативных путей получения данных

## Оптимизация производительности

Система использует асинхронную параллельную обработку для анализа предметов:
- Каждый предмет анализируется в отдельной асинхронной задаче
- Задачи выполняются группами по 10 для предотвращения перегрузки API
- Результаты кэшируются для ускорения повторных запросов

## Улучшения по сравнению с предыдущей версией

1. **Более точная оценка прибыли** - учитываются комиссии и реальные цены продаж
2. **Анализ ликвидности** - оценка скорости продажи предметов
3. **Прогнозирование цен** - использование ML для предсказания будущих цен
4. **Оценка риска** - учитывается волатильность цен и уверенность в прогнозе
5. **Параллельная обработка** - асинхронный анализ для ускорения работы
6. **Улучшенная обработка ошибок** - корректное восстановление после сбоев API
7. **Общая оценка возможностей** - комплексная оценка для ранжирования результатов

## Пример вывода

```
================================================================================
СВОДКА ПРОДВИНУТОГО АНАЛИЗА АРБИТРАЖНЫХ ВОЗМОЖНОСТЕЙ НА DMARKET
================================================================================

Всего найдено возможностей: 57

CS2: Найдено 22 прибыльных предметов

Топ-5 самых перспективных предметов в CS2:
Название                                 Цена покупки Цена продажи Прибыль    Прибыль %   Оценка
--------------------------------------------------------------------------------
AWP | Asiimov (Field-Tested)             $134.10    $159.00    $17.05     12.71    % 0.82
AK-47 | Redline (Field-Tested)           $22.30     $26.80     $3.16      14.17    % 0.76
M4A4 | Neo-Noir (Minimal Wear)           $45.60     $53.90     $5.61      12.30    % 0.71
USP-S | Kill Confirmed (Field-Tested)    $38.70     $46.10     $5.09      13.15    % 0.68
Desert Eagle | Code Red (Field-Tested)   $15.40     $19.10     $2.75      17.86    % 0.65
```

## Устранение неполадок

Если возникают ошибки при запуске:

1. Проверьте, что указаны корректные API ключи в файле `.env`
2. Убедитесь, что установлены все зависимости из `requirements.txt`
3. Если возникают ошибки с API, проверьте наличие ограничений на количество запросов
4. При проблемах с ML, попробуйте запустить с параметром `use_ml = False` 