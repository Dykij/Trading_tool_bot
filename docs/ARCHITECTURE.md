# Архитектура DMarket Trading Bot

Этот документ описывает архитектуру и структуру DMarket Trading Bot, объясняя взаимодействие компонентов и основные принципы проектирования.

## Обзор архитектуры

DMarket Trading Bot построен с использованием многослойной модульной архитектуры, состоящей из следующих основных компонентов:

```
┌─────────────────┐     ┌───────────────┐     ┌──────────────┐
│  Telegram Bot   │────▶│  Trading Core │────▶│  API Wrapper │
└─────────────────┘     └───────────────┘     └──────────────┘
        ▲                     ▲  │                   │
        │                     │  │                   │
        │                     │  │                   ▼
        │               ┌────┘  │            ┌──────────────┐
        │               ▼       │            │  DMarket API │
┌─────────────┐  ┌─────────────┐│            └──────────────┘
│   Handlers  │  │  Analytics  ││
└─────────────┘  └─────────────┘│
                              ┌─┘
                              ▼
                      ┌────────────────┐
                      │ Arbitrage Core │
                      └────────────────┘
```

## Слои архитектуры

### 1. Пользовательский интерфейс (`src/telegram/`)

Обеспечивает взаимодействие с пользователем через Telegram. Включает:
- `telegram_bot.py` - основная реализация Telegram бота
- `run_bot.py` - точка входа для запуска бота
- `keyboards.py` - клавиатуры для интерфейса бота

### 2. Обработчики команд (`src/bot/handlers/`)

Обрабатывают команды и сообщения, управляют состояниями пользователей:
- `commands.py` - обработчики основных команд
- Другие обработчики для различных функций

### 3. Бизнес-логика торговли (`src/trading/`)

Реализует основную бизнес-логику приложения:
- `trading_facade.py` - единый интерфейс для работы с торговой системой
- `trading_bot.py` - автоматизированный торговый бот

### 4. Алгоритмы арбитража (`src/arbitrage/`)

Содержит алгоритмы для поиска арбитражных возможностей:
- `bellman_ford.py` - алгоритм Беллмана-Форда для поиска циклов с отрицательным весом
- `linear_programming.py` - оптимизация торговой стратегии с использованием линейного программирования
- `stat_arbitrage.py` - алгоритмы статистического арбитража

### 5. Аналитика и прогнозирование (`src/analytics/`)

Предоставляет аналитические возможности и прогнозирование цен:
- `ml_predictor.py` - модуль для предсказания цен с использованием ML

### 6. API и интеграции (`src/api/`)

Взаимодействие с внешними API и сервисами:
- `api_wrapper.py` - обертка для работы с DMarket API
- `integration.py` - интеграции с другими торговыми площадками

### 7. Конфигурация и настройки (`src/config/`)

Содержит параметры конфигурации приложения:
- `config.py` - настройки и конфигурационные параметры

### 8. Слой доступа к данным (`src/db/`)

Отвечает за работу с данными и хранение состояний:
- `init_db.py` - инициализация и работа с БД

## Шаблоны проектирования

### Фасад (Facade)

`trading_facade.py` реализует шаблон Фасад, предоставляя унифицированный интерфейс к различным подсистемам: API DMarket, алгоритмам арбитража, ML моделям и т.д.

### Одиночка (Singleton)

Некоторые компоненты (например, соединение с базой данных, конфигурация) используют шаблон Одиночка для обеспечения единственного экземпляра объекта.

### Внедрение зависимостей (Dependency Injection)

Компоненты получают свои зависимости извне, что повышает тестируемость и облегчает замену реализаций.

### Наблюдатель (Observer)

Telegram бот использует обработчики, которые подписываются на события (команды, сообщения), что соответствует шаблону Наблюдатель.

## Основные функциональные компоненты

### Telegram Bot

Обеспечивает интерфейс для взаимодействия с пользователем через Telegram, обрабатывает команды, управляет состояниями пользователей.

### Trading Service

Основной сервис для выполнения торговых операций, получения цен и работы с предметами.

### Arbitrage Finder

Ищет арбитражные возможности на DMarket и между различными торговыми площадками, используя алгоритмы для поиска циклов с положительной прибылью.

### ML Predictor

Использует методы машинного обучения для анализа исторических данных о ценах и предсказания будущих цен предметов.

### DMarket API Wrapper

Обеспечивает доступ к API DMarket с обработкой ошибок, ограничениями запросов, аутентификацией и другими низкоуровневыми деталями.

## Потоки данных

### 1. Пользовательские команды

Telegram → Обработчики команд → Торговый фасад → API DMarket → Обработка результатов → Ответ пользователю

### 2. Поиск арбитражных возможностей

Запрос данных о ценах → Алгоритмы арбитража → Фильтрация возможностей → Оптимизация стратегии → Представление результатов

### 3. Предсказание цен

Получение исторических данных → Обработка данных → ML-модель → Предсказание → Представление результатов

## Расширяемость

Архитектура разработана с учетом расширяемости:

1. **Модульность** - компоненты слабо связаны, что позволяет заменять или добавлять новые модули
2. **Абстракции** - использование интерфейсов и абстрактных классов позволяет иметь несколько реализаций
3. **Конфигурируемость** - поведение приложения может быть настроено через параметры конфигурации

## Обработка ошибок и отказоустойчивость

- Централизованная обработка ошибок
- Механизмы повторных попыток для взаимодействия с внешними API
- Журналирование ошибок и важных событий
- Сохранение состояний для восстановления после сбоев

## Безопасность

- Защита API ключей и конфиденциальных данных через переменные окружения
- Проверка прав доступа для администраторских команд
- Валидация входных данных от пользователей
- Ограничение доступа к определенным функциям для неавторизованных пользователей

## Развертывание и масштабирование

Приложение может быть развернуто как:

1. Монолитное приложение на одном сервере
2. Набор микросервисов, каждый из которых отвечает за свою функциональность
3. Комбинация обоих подходов с разделением на ядро и дополнительные сервисы

## Конфигурация и настройка

Конфигурация осуществляется через:

1. Переменные окружения
2. Файл конфигурации `.env`
3. Параметры командной строки 