# Модели машинного обучения для прогнозирования цен

## Обзор

В данном документе представлена информация о моделях машинного обучения, используемых в проекте DMarket Trading Bot для прогнозирования цен предметов. Система использует несколько современных подходов, каждый из которых имеет свои преимущества и особенности.

## Доступные модели

### 1. Базовые модели (scikit-learn)

- **Random Forest Regressor** - ансамблевый метод, основанный на построении множества деревьев решений
- **Gradient Boosting Regressor** - метод, последовательно строящий модели для минимизации остаточной ошибки предыдущих моделей

Эти модели доступны в базовой версии проекта и не требуют установки дополнительных зависимостей, кроме `scikit-learn`.

### 2. Продвинутые бустинговые алгоритмы

- **CatBoost** - современная реализация градиентного бустинга от Яндекса с поддержкой категориальных признаков и быстрым обучением
- **LightGBM** - высокоэффективная реализация градиентного бустинга от Microsoft с фокусом на скорость и эффективность памяти
- **XGBoost** - популярная библиотека для градиентного бустинга с оптимизированным исполнением

Для использования этих моделей необходимо установить соответствующие библиотеки:
```bash
pip install catboost lightgbm xgboost
```

### 3. Prophet

Prophet - библиотека от Facebook для прогнозирования временных рядов. Особенно хорошо подходит для данных с выраженной сезонностью и трендами.

Ключевые особенности:
- Автоматическая обработка сезонности (дневная, недельная, годовая)
- Робастность к выбросам и пропущенным данным
- Возможность включения в модель известных событий (праздники, распродажи)

Для использования необходимо установить:
```bash
pip install prophet
```

### 4. Классические модели временных рядов

- **ARIMA** (AutoRegressive Integrated Moving Average) - классическая модель для временных рядов
- **SARIMA** (Seasonal ARIMA) - ARIMA с сезонным компонентом

Эти модели требуют установки библиотеки `statsmodels`:
```bash
pip install statsmodels
```

### 5. Ансамблевые методы

Система поддерживает комбинирование нескольких моделей для получения более точных прогнозов:

- **Weighted Average** - взвешенное среднее прогнозов, где вес определяется уверенностью модели
- **Simple Average** - простое среднее прогнозов нескольких моделей

## Использование моделей

### Базовое использование

```python
from src.ml.ml_predictor import MLPredictor

predictor = MLPredictor()
result = await predictor.predict_price(
    item_name="AK-47 | Redline",
    game_id="csgo",
    model_type="random_forest",
    days_ahead=7
)
```

### Использование Prophet

```python
result = await predictor.predict_price_with_prophet(
    item_name="AK-47 | Redline",
    game_id="csgo",
    days_ahead=7,
    seasonality_mode="multiplicative",
    include_history=True
)
```

### Использование продвинутых бустинговых алгоритмов

```python
result = await predictor.predict_price_with_boosting(
    item_name="AK-47 | Redline",
    game_id="csgo",
    model_type="catboost", # или "lightgbm", "xgboost"
    days_ahead=7
)
```

### Использование ARIMA/SARIMA

```python
result = await predictor.predict_price_with_arima(
    item_name="AK-47 | Redline",
    game_id="csgo",
    days_ahead=7,
    model_type="auto", # или "arima", "sarima"
    include_history=True
)
```

### Ансамбль моделей

```python
result = await predictor.predict_price_ensemble(
    item_name="AK-47 | Redline",
    game_id="csgo",
    days_ahead=7,
    ensemble_method="weighted", # или "average", "auto"
    models_to_use=["prophet", "boosting", "arima", "random_forest"],
    include_history=True
)
```

## Формат результатов

Все методы прогнозирования возвращают структуру с общими полями:

```json
{
  "status": "success",
  "item_name": "AK-47 | Redline",
  "current_price": 15.75,
  "predicted_price": 17.23,
  "confidence": 0.85,
  "prediction_date": "2023-07-01",
  "model_type": "ensemble",
  "forecast": [
    {"date": "2023-06-25", "price": 16.05},
    {"date": "2023-06-26", "price": 16.35},
    ...
  ]
}
```

Некоторые модели предоставляют дополнительные поля:
- `lower_bound` и `upper_bound` - доверительный интервал прогноза
- `history` - историческая информация о ценах
- `seasonality_components` - разложение прогноза на компоненты (тренд, сезонность)

## Выбор оптимальной модели

Для разных предметов и временных горизонтов оптимальными могут быть разные модели:

1. **Prophet** - лучше работает с предметами, имеющими регулярные сезонные паттерны (например, еженедельные распродажи)
2. **Бустинговые алгоритмы** - хорошо работают при наличии множества признаков и сложных зависимостей
3. **ARIMA/SARIMA** - подходят для данных с четкими трендами и минимальным шумом
4. **Ансамблевые методы** - обычно дают наилучшие результаты, учитывая сильные стороны разных моделей

Рекомендуется использовать ансамблевый метод `predict_price_ensemble` с параметром `ensemble_method="auto"`, который автоматически выберет оптимальный способ комбинирования прогнозов.

## Метрики качества

Для оценки качества моделей используются следующие метрики:

- **MAE** (Mean Absolute Error) - средняя абсолютная ошибка
- **RMSE** (Root Mean Squared Error) - корень из среднеквадратичной ошибки
- **R²** (R-squared) - коэффициент детерминации

Метрики доступны в результатах некоторых методов прогнозирования в поле `metrics`. 