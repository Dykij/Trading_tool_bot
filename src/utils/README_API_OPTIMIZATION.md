# API Оптимизация

Данный модуль предоставляет инструменты для оптимизации работы с DMarket API, улучшая производительность и эффективность API-запросов.

## Содержание

- [Обзор](#обзор)
- [Компоненты](#компоненты)
- [Используемые техники оптимизации](#используемые-техники-оптимизации)
- [Как использовать](#как-использовать)
- [Примеры](#примеры)
- [Интеграция с code_tools](#интеграция-с-code_tools)
- [Мониторинг и статистика](#мониторинг-и-статистика)

## Обзор

API оптимизация включает в себя набор инструментов для:
- Кэширования результатов API запросов с настраиваемым TTL (time-to-live)
- Мониторинга и профилирования производительности API
- Интеллектуального управления повторными попытками и обработки ошибок
- Ограничения частоты запросов для соблюдения лимитов API

## Компоненты

1. **function_optimizer.py** - базовый класс с декораторами для оптимизации функций:
   - `timer` - измерение времени выполнения
   - `memoize` - кэширование результатов
   - `debug_log` - логирование вызовов функций
   - `rate_limit` - ограничение частоты вызовов
   - `retry` - автоматические повторные попытки при ошибках

2. **api_optimizer.py** - специализированный оптимизатор для API:
   - Класс `APIOptimizer` адаптирует функциональность базового оптимизатора для работы с API
   - Предоставляет декоратор `optimize_api_method` для применения комплексных оптимизаций к методам API
   - Собирает статистику использования API
   - Поддерживает кэширование с TTL и отслеживание кэшированных методов

3. **optimized_api_client.py** - готовая к использованию обертка для DMarket API:
   - Класс `OptimizedDMarketAPI` наследует функциональность оригинального API клиента
   - Применяет разные стратегии кэширования для разных типов запросов
   - Предоставляет интерфейс для мониторинга производительности
   - Использует более эффективный подход к созданию оптимизированных методов

4. **code_tools/api_optimizations.py** - утилита для программной оптимизации API-функций:
   - Автоматическое добавление оптимизаций к существующему коду
   - Интеграция с AST-инструментами для модификации исходного кода
   - Настраиваемые шаблоны оптимизаций для различных типов API-методов

## Используемые техники оптимизации

### 1. Интеллектуальное кэширование
- Разные TTL для разных типов запросов
- Кэширование на основе параметров запроса
- Автоматическая инвалидация кэша по истечении времени
- Надежная очистка кэша через отслеживание кэшированных методов

### 2. Умная обработка повторных попыток
- Экспоненциальная задержка между попытками
- Избирательные повторные попытки в зависимости от типа ошибки
- Автоматическое соблюдение лимитов API при повторе

### 3. Профилирование производительности
- Измерение времени выполнения запросов
- Сбор статистики по успешным/неудачным запросам
- Вычисление средней производительности

## Как использовать

### Базовое использование

```python
from src.utils.optimized_api_client import OptimizedDMarketAPI

# Создание экземпляра оптимизированного клиента
api = OptimizedDMarketAPI(api_key="ваш_ключ", api_secret="ваш_секрет")

# Использование как обычного API клиента
items = api.get_market_items(game="csgo", limit=10)

# Повторные запросы будут использовать кэш
items_again = api.get_market_items(game="csgo", limit=10)  # Быстрее, из кэша

# Получение статистики использования
stats = api.get_stats()
print(stats)

# Очистка кэша при необходимости
api.clear_caches()
```

### Применение оптимизации к собственным методам

```python
from src.utils.api_optimizer import APIOptimizer, create_optimized_api

# Создание оптимизатора
optimizer = create_optimized_api(api_key, api_secret)

# Оптимизация собственного метода
@optimizer.optimize_api_method(cache_ttl=30, enable_profiling=True)
def my_custom_api_method(param1, param2):
    # Логика работы с API
    return result
```

## Примеры

В директории `src/examples/api_optimization_example.py` содержится полный пример использования оптимизированного API клиента и сравнения его производительности с оригинальным API. Примеры включают:
- Сравнение производительности стандартного и оптимизированного API
- Демонстрация кэширования и его влияния на скорость работы
- Тестирование очистки кэша и проверка его эффективности

## Интеграция с code_tools

Модуль `src/utils/code_tools/api_optimizations.py` предоставляет инструменты для программной оптимизации существующих API-функций:

```python
from src.utils.code_tools.api_optimizations import apply_api_optimizations

# Чтение исходного кода
with open('my_api_file.py', 'r') as f:
    source_code = f.read()

# Применение оптимизаций к методам API
optimized_code = apply_api_optimizations(source_code)

# Сохранение оптимизированного кода
with open('my_api_file_optimized.py', 'w') as f:
    f.write(optimized_code)
```

Также доступен командно-строчный интерфейс:

```bash
python -m src.utils.code_tools.api_optimizations src/api/api_wrapper.py --output src/api/api_wrapper_optimized.py
```

## Мониторинг и статистика

Оптимизированный API клиент собирает следующую статистику:

- `total_requests` - общее количество запросов
- `successful_requests` - успешные запросы
- `failed_requests` - неудачные запросы
- `cache_hits` - количество обращений к кэшу
- `average_response_time` - среднее время ответа

Для получения статистики используйте метод `get_stats()`.

```python
stats = api.get_stats()
print(f"Кэш использован {stats['cache_hits']} раз")
print(f"Среднее время ответа: {stats['average_response_time']:.4f} секунд")
``` 