# Обновление DMarket Trading Bot

В этом документе описаны улучшения, внесенные в систему DMarket Trading Bot, и инструкции по обновлению.

## Внесенные улучшения

### 1. Улучшение поиска вещей для арбитражной торговли

- **ML-интеграция**: Добавлена возможность использования машинного обучения для предсказания будущих цен и оценки потенциально прибыльных предметов.
- **Оптимизация структур данных**: Улучшены алгоритмы поиска и структуры данных для более эффективного поиска арбитражных возможностей.
- **Усовершенствованный кэш**: Внедрена система `SmartCache` с адаптивным временем жизни данных в зависимости от волатильности рынка.
- **Расчет ликвидности**: Добавлен улучшенный алгоритм расчета ликвидности предметов для более точного определения рисков.

### 2. Улучшение взаимодействия с API DMarket

- **Разделение ответственности**: Усовершенствована архитектура с более четким разделением между бизнес-логикой и взаимодействием с API.
- **Батчинг запросов**: Реализован механизм группировки запросов к API для снижения нагрузки и более эффективного использования лимитов.
- **Асинхронные вызовы**: Оптимизировано асинхронное взаимодействие с API для повышения производительности.
- **Контроль параллельности**: Добавлено ограничение количества одновременных запросов с помощью семафоров.
- **Безопасная работа с ценовыми диапазонами**: Улучшен метод `get_market_items_batch`, обеспечивающий корректную обработку пустых параметров price_ranges.
- **Оптимизация кэширования**: Добавлено умное кэширование результатов API запросов с учетом специфики конкретных эндпоинтов.

### 3. Оптимизация работы Telegram бота

- **Поддержка вебхуков**: Добавлена поддержка вебхуков для более эффективной работы бота при большом количестве пользователей.
- **Очереди сообщений**: Реализована система очередей для асинхронной обработки сообщений и уведомлений.
- **Улучшенная безопасность**: Добавлены компоненты для контроля доступа, ограничения частоты запросов и двухфакторной аутентификации.
- **Интеграция с Redis**: Добавлена возможность использования Redis для хранения состояний и сессий.
- **Интеграция новых обработчиков**: Реализована удобная система регистрации новых обработчиков для дашборда и песочницы.

### 4. Улучшения репозитория

- **Конфигурация**: Усовершенствована система конфигурации с использованием Pydantic и переменных окружения.
- **Логирование**: Улучшена система логирования с поддержкой ротации файлов и различных уровней детализации.
- **Зависимости**: Обновлен файл requirements.txt с дополнительными зависимостями для новых функций.
- **Документация**: Добавлены документы с инструкциями по настройке и использованию новых возможностей.
- **Типизация**: Улучшена типизация кода для обеспечения лучшей документации и устранения ошибок.

## Новые функции

### Аналитическая панель (Dashboard)

Мы добавили аналитическую панель, которая предоставляет детальную информацию о работе бота и результатах торговли. Дашборд доступен через команду `/dashboard` в Telegram боте.

**Основные возможности дашборда:**

- Общий обзор системы (CPU, память, API метрики)
- Статистика торговых операций (успешность, прибыль, количество)
- Графики прибыли и производительности системы
- Топ предметов по прибыльности
- Метрики арбитражных операций
- Интерактивные графики с возможностью масштабирования
- Фильтрация данных по времени (день, неделя, месяц, всё время)
- Экспорт отчетов в различных форматах

Дашборд автоматически кэширует данные для оптимизации производительности и предоставляет различные фильтры по времени для анализа.

### Режим песочницы (Sandbox)

Мы также добавили режим песочницы, который позволяет тестировать торговые стратегии без риска потери реальных средств. Песочница доступна через команду `/sandbox` в Telegram боте.

**Основные возможности режима песочницы:**

- Виртуальный баланс и инвентарь
- Симуляция торговли на исторических данных
- Возможность ускорить или замедлить симуляцию
- Настраиваемая волатильность рынка
- Полная статистика и отчеты по результатам тестирования
- Возможность ручного управления ценами
- Сравнение различных стратегий торговли
- Автоматический анализ эффективности стратегий
- Экспорт результатов симуляций для дальнейшего анализа

Режим песочницы особенно полезен для новых пользователей и тестирования новых стратегий перед их применением на реальном рынке.

### Настройка новых функций

Для настройки новых функций отредактируйте файл `.env`:

```
# Настройки для дашборда и режима песочницы
ENABLE_DASHBOARD=true
ENABLE_SANDBOX=true
DASHBOARD_REFRESH_INTERVAL=300
SANDBOX_DEFAULT_BALANCE=1000
SANDBOX_TRANSACTION_FEE=0.03
```

Дополнительно для поддержки дашборда и песочницы установите необходимые зависимости:

```bash
pip install matplotlib pandas numpy tabulate Pillow plotly kaleido statsmodels
```

Эти зависимости уже включены в обновленный файл `requirements.txt`.

## Инструкции по обновлению

### Предварительные требования

Перед обновлением убедитесь, что:
- У вас есть резервная копия текущей системы
- Установлена Python 3.7+ и pip

### Шаг 1: Обновление зависимостей

```bash
pip install -r requirements.txt
```

### Шаг 2: Настройка конфигурации

1. Обновите файл `.env` на основе `.env.example`:
   ```bash
   cp .env.example .env.new
   # Перенесите свои настройки из .env в .env.new и проверьте новые параметры
   mv .env.new .env
   ```

2. Настройте параметры для использования вебхуков (если планируете использовать):
   ```
   USE_WEBHOOK=true
   WEBHOOK_HOST=https://your-domain.com
   WEBHOOK_PATH=/webhook/your_bot_token_here
   WEBAPP_PORT=8443
   ```

3. Настройте Redis (опционально, для повышения производительности):
   ```
   USE_REDIS=true
   REDIS_URL=redis://localhost:6379/0
   ```

### Шаг 3: Настройка безопасности

1. Настройте список разрешенных пользователей в `.env`:
   ```
   ALLOWED_USERS=123456789,987654321
   ```

2. Для использования двухфакторной аутентификации:
   ```
   ENABLE_2FA=true
   ```

3. Настройте параметры безопасности:
   ```
   JWT_SECRET=your_secure_random_string
   ENCRYPTION_KEY=your_secure_random_string
   ```

### Шаг 4: Настройка для ML-интеграции

Если вы планируете использовать машинное обучение для предсказания цен:

1. Включите использование ML в `.env`:
   ```
   USE_ML=true
   ```

2. При первом запуске с ML потребуется некоторое время для обучения модели на исторических данных.

### Шаг 5: Настройка дашборда и песочницы

1. Включите дашборд и песочницу в `.env`:
   ```
   ENABLE_DASHBOARD=true
   ENABLE_SANDBOX=true
   ```

2. Настройте параметры по умолчанию:
   ```
   DASHBOARD_REFRESH_INTERVAL=300
   SANDBOX_DEFAULT_BALANCE=1000
   SANDBOX_TRANSACTION_FEE=0.03
   ```

### Шаг 6: Запуск обновленной системы

```bash
python main.py
```

### Дополнительные действия для использования вебхуков

Если вы настроили использование вебхуков:

1. Убедитесь, что у вас есть домен с SSL-сертификатом
2. Настройте переадресацию портов на вашем сервере
3. Проверьте доступность webhook-URL через браузер

## Решение проблем

### Проблемы с Redis

Если возникают ошибки с подключением к Redis:

```bash
# Проверьте статус Redis
systemctl status redis

# Установите Redis, если он не установлен
apt-get install redis-server
```

### Проблемы с ML-моделью

Если модель не обучается или делает неточные предсказания:

```bash
# Сбросьте кэш модели
rm -rf cache/ml_models/*

# Увеличьте количество исторических данных
python data_collector.py --days 60
```

### Проблемы с вебхуками

Если вебхуки не работают:

1. Проверьте настройки вашего веб-сервера
2. Убедитесь, что SSL-сертификат действителен
3. Проверьте журналы ошибок в папке `logs/`

### Проблемы с дашбордом

Если дашборд не отображается или отображается некорректно:

1. Проверьте, что установлены все необходимые зависимости:
   ```bash
   pip install matplotlib pandas numpy tabulate Pillow plotly kaleido
   ```

2. Убедитесь, что у вас есть права на запись в папку для метрик и графиков
3. Проверьте журналы ошибок в папке `logs/dashboard.log`

### Проблемы с песочницей

Если режим песочницы не работает:

1. Убедитесь, что база данных настроена корректно
2. Проверьте наличие исторических данных о ценах
3. Проверьте журналы ошибок в папке `logs/sandbox.log`

## Обратная связь

Если у вас возникли проблемы с обновлением или у вас есть предложения по улучшению, пожалуйста, создайте issue в репозитории или свяжитесь с разработчиками. 